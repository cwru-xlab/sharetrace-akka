db.parameter.aggregate([
  {
    $group: {
      _id: {
        datasetId: '$dataset.id',
        networkId: '$network.id',
        networkType: '$networkFactory.type',
        sendCoefficient: '$parameters.sendCoefficient',
        ctRandomType: '$networkFactory.timeFactory.random.type',
        stRandomType: '$scoreFactory.timeFactory.random.type',
        svRandomType: '$scoreFactory.random.type',
      },
      count: { $count: {} },
      edges: {$push: '$network.edges'},
      runtime: { $push: '$results.runtime.MessagePassing' },
      contacts: { $push: '$results.user.counts.ContactEvent' },
      receives: { $push: '$results.user.counts.ReceiveEvent' },
      updates: { $push: '$results.user.counts.UpdateEvent' },
      users: { $push: '$results.user.counts.LastEvent' },
      updateDiffs: { $push: '$results.user.updates.difference' },
      sourceCardinality: { $push: '$results.reachability.source' },
      influenceCardinality: { $push: '$results.reachability.influence' },
      msgReachability: { $push: '$results.reachability.message' },
    }
  },
  {
    $set: {
      totalContacts: { $map: { input: '$contacts', in: { $sum: '$$this' } } },
      totalReceives: { $map: { input: '$receives', in: { $sum: '$$this' } } },
      totalUpdates: { $map: { input: '$updates', in: { $sum: '$$this' } } },
      totalUsers: { $map: { input: '$users', in: { $sum: '$$this' } } },
      totalUpdateDiffs: { $map: { input: '$updateDiffs', in: { $sum: '$$this' } } },
      totalSourceCardinality: { $map: { input: '$sourceCardinality', in: { $sum: '$$this' } } },
      totalInfluenceCardinality: { $map: { input: '$influenceCardinality', in: { $sum: '$$this' } } },
      totalMsgReachability: { $map: { input: '$msgReachability', in: { $sum: '$$this' } } },
    }
  },
  {
    $set: {
      contacts: {
        $reduce: {
          input: '$contacts',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      receives: {
        $reduce: {
          input: '$receives',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      updates: {
        $reduce: {
          input: '$updates',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      users: {
        $reduce: {
          input: '$users',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      updateDiffs: {
        $reduce: {
          input: '$updateDiffs',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      sourceCardinality: {
        $reduce: {
          input: '$sourceCardinality',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      influenceCardinality: {
        $reduce: {
          input: '$influenceCardinality',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      },
      msgReachability: {
        $reduce: {
          input: '$msgReachability',
          initialValue: [],
          in: { $concatArrays: ['$$value', '$$this'] }
        }
      }
    }
  },
  {
    $set: {
      avgEdges: {$avg: '$edges'},
      avgRuntime: { $avg: '$runtime' },
      avgContacts: { $avg: '$contacts' },
      avgReceives: { $avg: '$receives' },
      avgUpdates: { $avg: '$updates' },
      avgUpdateDiffs: { $avg: '$updateDiffs' },
      avgSourceCardinality: { $avg: '$sourceCardinality' },
      avgInfluenceCardinality: { $avg: '$influenceCardinality' },
      avgMsgReachability: { $avg: '$msgReachability' },
      avgTotalContacts: { $avg: '$totalContacts' },
      avgTotalReceives: { $avg: '$totalReceives' },
      avgTotalUpdates: { $avg: '$totalUpdates' },
      avgTotalUsers: { $avg: '$totalUsers' },
      avgTotalUpdateDiffs: { $avg: '$totalUpdateDiffs' },
      avgTotalSourceCardinality: { $avg: '$totalSourceCardinality' },
      avgTotalInfluenceCardinality: { $avg: '$totalInfluenceCardinality' },
      avgTotalMsgReachability: { $avg: '$totalMsgReachability' },
      seRuntime: { $divide: [{ $stdDevSamp: '$runtime' }, { $sqrt: '$count' }] },
      seContacts: { $divide: [{ $stdDevSamp: '$contacts' }, { $sqrt: '$count' }] },
      seReceives: { $divide: [{ $stdDevSamp: '$receives' }, { $sqrt: '$count' }] },
      seUpdates: { $divide: [{ $stdDevSamp: '$updates' }, { $sqrt: '$count' }] },
      seUpdateDiffs: { $divide: [{ $stdDevSamp: '$updateDiffs' }, { $sqrt: '$count' }] },
      seSourceCardinality: { $divide: [{ $stdDevSamp: '$sourceCardinality' }, { $sqrt: '$count' }] },
      seInfluenceCardinality: { $divide: [{ $stdDevSamp: '$influenceCardinality' }, { $sqrt: '$count' }] },
      seMsgReachability: { $divide: [{ $stdDevSamp: '$msgReachability' }, { $sqrt: '$count' }] },
      seTotalContacts: { $divide: [{ $stdDevSamp: '$totalContacts' }, { $sqrt: '$count' }] },
      seTotalReceives: { $divide: [{ $stdDevSamp: '$totalReceives' }, { $sqrt: '$count' }] },
      seTotalUpdates: { $divide: [{ $stdDevSamp: '$totalUpdates' }, { $sqrt: '$count' }] },
      seTotalUsers: { $divide: [{ $stdDevSamp: '$totalUsers' }, { $sqrt: '$count' }] },
      seTotalUpdateDiffs: { $divide: [{ $stdDevSamp: '$totalUpdateDiffs' }, { $sqrt: '$count' }] },
      seTotalSourceCardinality: { $divide: [{ $stdDevSamp: '$totalSourceCardinality' }, { $sqrt: '$count' }] },
      seTotalInfluenceCardinality: { $divide: [{ $stdDevSamp: '$totalInfluenceCardinality' }, { $sqrt: '$count' }] },
      seTotalMsgReachability: { $divide: [{ $stdDevSamp: '$totalMsgReachability' }, { $sqrt: '$count' }] },
    }
  },
  {
    $set: {
      datasetId: '$_id.datasetId',
      networkId: '$_id.networkId',
      networkType: '$_id.networkType',
      sendCoefficient: '$_id.sendCoefficient',
      ctRandomType: '$_id.ctRandomType',
      stRandomType: '$_id.stRandomType',
      svRandomType: '$_id.svRandomType',
    }
  },
  {
    $unset: [
      'edges',
      '_id',
      'count',
      'runtime',
      'contacts',
      'receives',
      'updates',
      'users',
      'updateDiffs',
      'sourceCardinality',
      'influenceCardinality',
      'msgReachability',
      'totalContacts',
      'totalReceives',
      'totalUpdates',
      'totalUsers',
      'totalUpdateDiffs',
      'totalSourceCardinality',
      'totalInfluenceCardinality',
      'totalMsgReachability'
    ]
  }
])